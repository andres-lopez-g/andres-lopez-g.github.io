<nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom {% if page.nav-short %}top-nav-short-permanent{% else %}top-nav-regular{% endif %}">

  {%- assign curr_lang = page.language | default: site.language | default: 'en' -%}
  {%- if curr_lang == 'en' -%}
    {%- assign home_href = '/en/' -%}
  {%- else -%}
    {%- assign home_href = '/' -%}
  {%- endif -%}
  {%- if site.title-img -%}
    <a class="navbar-brand navbar-brand-logo" href="{{ home_href | absolute_url }}"><img alt="{{ site.title }} Logo" src="{{ site.title-img | relative_url}}"/></a>
  {%- elsif site.title -%}
    <a class="navbar-brand" href="{{ home_href | absolute_url }}">{{ site.title }}</a>
  {%- endif -%}

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
      {%- for link in site.navbar-links -%}
        {%- if link[1].first %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ link[0] }}</a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
              {%- for childlink in link[1] -%}
                {%- for linkparts in childlink %}
                  {%- assign raw = linkparts[1] -%}
                  {%- assign has_proto = raw contains '://' -%}
                  {%- assign is_mailto = raw contains 'mailto:' -%}
                  {%- if has_proto or is_mailto -%}
                    {%- assign local_url = raw -%}
                  {%- else -%}
                    {%- assign clean = raw | remove_first: '/' -%}
                    {%- if curr_lang == 'en' -%}
                      {%- assign local_url = '/en/' | append: clean -%}
                    {%- else -%}
                      {%- assign local_url = '/' | append: clean -%}
                    {%- endif -%}
                  {%- endif -%}
                  <a class="dropdown-item" href="{{ local_url | relative_url }}">{{ linkparts[0] }}</a>
                {%- endfor -%}
              {%- endfor %}
            </div>
          </li>
        {% else %}
          <li class="nav-item">
            {%- assign raw = link[1] -%}
            {%- assign has_proto = raw contains '://' -%}
            {%- assign is_mailto = raw contains 'mailto:' -%}
            {%- if has_proto or is_mailto -%}
              {%- assign local_url = raw -%}
            {%- else -%}
              {%- assign clean = raw | remove_first: '/' -%}
              {%- if curr_lang == 'en' -%}
                {%- assign local_url = '/en/' | append: clean -%}
              {%- else -%}
                {%- assign local_url = '/' | append: clean -%}
              {%- endif -%}
            {%- endif -%}
            <a class="nav-link" href="{{ local_url | relative_url }}">{{ link[0] }}</a>
          </li>
        {%- endif -%}
      {%- endfor -%}
  {% if site.post_search %}
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
    <span id="nav-search-text">{%- if curr_lang == 'es' -%}Buscar{%- else -%}Search{%- endif -%}</span>
          </a>
        </li>
      {%- endif -%}

      {%- comment -%}
      Language switcher: looks for a sibling page/post with the same lang_ref
      in the alternate language. If not found, links to the alt language home.
      {%- endcomment -%}
      {%- if curr_lang == 'en' -%}
        {%- assign alt_lang = 'es' -%}
      {%- else -%}
        {%- assign alt_lang = 'en' -%}
      {%- endif -%}

      {%- assign alt_item = nil -%}
      {%- if page.lang_ref -%}
        {%- for p in site.pages -%}
          {%- if p.lang_ref == page.lang_ref and p.language == alt_lang -%}
            {%- assign alt_item = p -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if alt_item == nil -%}
          {%- for p in site.posts -%}
            {%- if p.lang_ref == page.lang_ref and p.language == alt_lang -%}
              {%- assign alt_item = p -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endif -%}

      {%- if alt_lang == 'en' -%}
        {%- assign alt_home = '/en/' -%}
      {%- else -%}
        {%- assign alt_home = '/' -%}
      {%- endif -%}

      <li class="nav-item ml-2">
        <a class="nav-link" href="{{ (alt_item.url | default: alt_home) | absolute_url }}">
          {%- if curr_lang == 'en' -%}ES{%- else -%}EN{%- endif -%}
        </a>
      </li>
    </ul>
  </div>

  {% if site.navbar-extra %}
    {% for file in site.navbar-extra %}
      {% include {{ file }} %}
    {% endfor %}
  {% endif %}

  {% if site.avatar and page.show-avatar != false %}
    <div class="avatar-container">
      <div class="avatar-img-border">
  <a href="{{ home_href | absolute_url }}">
          <img alt="Navigation bar avatar" class="avatar-img" src="{{ site.avatar | relative_url }}" />
        </a>
      </div>
    </div>
  {% endif %}

</nav>

{% include search.html %}
